<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://www.elcodi.io/cookbook/adapters/metric-bucket/">
        <link rel="shortcut icon" href="../../../img/favicon.ico">

        <title>Metric bucket - Elcodi Documentation</title>

        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../../css/highlight.css">

        <link href="../../../css/elcodi.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../../.."><img src="../../../img/elcodi.png" height="30" /></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                
                
                
                    
                        <li >
                            <a href="../../../quick-start/">Quick start</a>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Book <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../../book/cart-architecture/">Cart architecture</a>
</li>

                            
                                
<li >
    <a href="../../../book/category-architecture/">Category architecture</a>
</li>

                            
                                
<li >
    <a href="../../../book/commands/">Commands</a>
</li>

                            
                                
<li >
    <a href="../../../book/coupon-architecture/">Coupon architecture</a>
</li>

                            
                                
<li >
    <a href="../../../book/dictionary/">Dictionary</a>
</li>

                            
                                
<li >
    <a href="../../../book/emails/">Emails</a>
</li>

                            
                                
<li >
    <a href="../../../book/events/">Events</a>
</li>

                            
                                
<li >
    <a href="../../../book/">Home</a>
</li>

                            
                                
<li >
    <a href="../../../book/payments/">Payments</a>
</li>

                            
                                
<li >
    <a href="../../../book/philosophy/">Philosophy</a>
</li>

                            
                                
<li >
    <a href="../../../book/plugins/">Plugins</a>
</li>

                            
                                
<li >
    <a href="../../../book/processes/">Processes</a>
</li>

                            
                                
<li >
    <a href="../../../book/product-architecture/">Product architecture</a>
</li>

                            
                                
<li >
    <a href="../../../book/pull-requests/">Pull requests</a>
</li>

                            
                                
<li >
    <a href="../../../book/roadmap/">Roadmap</a>
</li>

                            
                                
<li >
    <a href="../../../book/running-test-suite/">Running test suite</a>
</li>

                            
                                
<li >
    <a href="../../../book/shipping/">Shipping</a>
</li>

                            
                                
<li >
    <a href="../../../book/standards/">Standards</a>
</li>

                            
                                
<li >
    <a href="../../../book/templates/">Templates</a>
</li>

                            
                                
<li >
    <a href="../../../book/vagrant-quick-start/">Vagrant quick start</a>
</li>

                            
                                
<li >
    <a href="../../../book/what-is-elcodi/">What is elcodi</a>
</li>

                            
                                
<li >
    <a href="../../../book/why-elcodi/">Why elcodi</a>
</li>

                            
                            </ul>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown active">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../">Home</a>
</li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Installation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../installation/install-a-plugin/">Install a plugin</a>
</li>

        
            
<li >
    <a href="../../installation/install-dependent-bundles/">Install dependent bundles</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Overwrite</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../overwrite/overwrite-a-parameter/">Overwrite a parameter</a>
</li>

        
            
<li >
    <a href="../../overwrite/overwrite-a-service/">Overwrite a service</a>
</li>

        
            
<li >
    <a href="../../overwrite/overwrite-an-entity/">Overwrite an entity</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Deprecation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../deprecation/deprecate-a-method/">Deprecate a method</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Adapters</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../currency-rates-populator/">Currency rates populator</a>
</li>

        
            
<li >
    <a href="../image-resize/">Image resize</a>
</li>

        
            
<li >
    <a href="../location-loader/">Location loader</a>
</li>

        
            
<li >
    <a href="../location-populator/">Location populator</a>
</li>

        
            
<li >
    <a href="../location-provider/">Location provider</a>
</li>

        
            
<li class="active">
    <a href="./">Metric bucket</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Workflow</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../workflow/create-automatic-coupon/">Create automatic coupon</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Usage</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../usage/elcodi-watermark/">Elcodi watermark</a>
</li>

        
            
<li >
    <a href="../../usage/referrer-domain/">Referrer domain</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Implementation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../implementation/implement-a-collector/">Implement a collector</a>
</li>

        
            
<li >
    <a href="../../implementation/implement-a-controller-and-a-command/">Implement a controller and a command</a>
</li>

        
            
<li >
    <a href="../../implementation/implement-a-factory/">Implement a factory</a>
</li>

        
            
<li >
    <a href="../../implementation/implement-a-form-type/">Implement a form type</a>
</li>

        
            
<li >
    <a href="../../implementation/implement-a-repository/">Implement a repository</a>
</li>

        
            
<li >
    <a href="../../implementation/implement-an-entity/">Implement an entity</a>
</li>

        
            
<li >
    <a href="../../implementation/implement-an-event-listener/">Implement an event listener</a>
</li>

        
    </ul>
  </li>

                            
                            </ul>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Component <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../../component/entity-translator/">Entity translator</a>
</li>

                            
                                
<li >
    <a href="../../../component/">Home</a>
</li>

                            
                                
<li >
    <a href="../../../component/media/">Media</a>
</li>

                            
                                
<li >
    <a href="../../../component/menu/">Menu</a>
</li>

                            
                                
<li >
    <a href="../../../component/metrics/">Metrics</a>
</li>

                            
                                
<li >
    <a href="../../../component/sitemap/">Sitemap</a>
</li>

                            
                                
<li >
    <a href="../../../component/state-transition-machine/">State transition machine</a>
</li>

                            
                                
<li >
    <a href="../../../component/template/">Template</a>
</li>

                            
                            </ul>
                        </li>
                    
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../location-provider/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../workflow/create-automatic-coupon/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/elcodi/docs">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#how-to-add-a-new-metric-bucket-adapter">How to add a new Metric Bucket adapter¡</a></li>
        
            <li><a href="#scenario">Scenario</a></li>
        
            <li><a href="#solution">Solution</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="how-to-add-a-new-metric-bucket-adapter">How to add a new Metric Bucket adapter¡<a class="headerlink" href="#how-to-add-a-new-metric-bucket-adapter" title="Permanent link"> #</a></h1>
<p>By default, Elcodi provides one Metric Bucket implementation, based on Redis.
You can read more information about this in the
<a href="../../../component/metrics/">Book Metrics Chapter</a>. This feature has been implemented
using Adapters as well, so you could implement your own.</p>
<h2 id="scenario">Scenario<a class="headerlink" href="#scenario" title="Permanent link"> #</a></h2>
<p>You have your store installed in third party environment. Bad news... Redis is
not installed and you cannot install it even if you want it. This scenario is
very common, so you should be able to use Metrics as well, even without Redis.</p>
<h2 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link"> #</a></h2>
<p>Well, first of all you should think about where to place your metric cache. A
bucket is nothing but a cache layer for your metrics. Each metric entry is a
database entry as well, but because only working with Doctrine would be so hard
for your server and user, we work with a cache layer.</p>
<p>This cache implementation should be able to build results in a very fast way, so
this is the reason why default implementation uses Redis.</p>
<h3 id="abstractmetricsbucket">AbstractMetricsBucket<a class="headerlink" href="#abstractmetricsbucket" title="Permanent link"> #</a></h3>
<p>Like every other adapters implementations, there is an Interface for that.
Remember that an abstract class can work as an interface as well if you define
methods as abstract.</p>
<p>AbstractMetricsBucket is your class if you want to create a new adapter for
that.</p>
<pre><code class="php">namespace Elcodi\Component\Metric\Core\Bucket\Abstracts;

use Elcodi\Component\Metric\Core\Entity\Interfaces\EntryInterface;

/**
 * Class AbstractMetricsBucket
 */
abstract class AbstractMetricsBucket
{
    /**
     * Add Metric into Bucket
     *
     * @param EntryInterface $entry Entry
     *
     * @return $this Self Object
     */
    abstract public function add(EntryInterface $entry);

    /**
     * Get number of unique beacons given an event and a set of dates
     *
     * @param string $token Event
     * @param string $event Token
     * @param array  $dates Dates
     *
     * @return integer Number of hits
     */
    abstract public function getBeaconsUnique($token, $event, array $dates);

    /**
     * Get the total of beacons given an event and a set of dates
     *
     * @param string $token Event
     * @param string $event Token
     * @param array  $dates Dates
     *
     * @return integer Number of beacons, given an event and dates
     */
    abstract public function getBeaconsTotal($token, $event, array $dates);

    /**
     * Get distributions given an event and a set of dates
     *
     * @param string $token Event
     * @param string $event Token
     * @param array  $dates Dates
     *
     * @return integer Accumulation of event and given dates
     */
    abstract public function getAccumulation($token, $event, array $dates);

    /**
     * Get distributions given an event and a set of dates
     *
     * [
     *      &quot;value3&quot;: 24,
     *      &quot;value7&quot;: 13,
     *      &quot;value8&quot;: 9,
     * ]
     *
     * @param string $token Event
     * @param string $event Token
     * @param array  $dates Dates
     *
     * @return array Distribution with totals
     */
    abstract public function getDistributions($token, $event, array $dates);
}
</code></pre>

<p>This class provides you some helpers as well, related to how cache keys should
be built in order to avoid collisions inside the bucket</p>
<pre><code class="php">/**
 * Create key given an entry
 *
 * @param string $token Event
 * @param string $event Token
 * @param string $date  Date
 *
 * @return string key
 */
protected function generateEntryKey($token, $event, $date)
{
    return
        $this-&gt;normalizeForKey($token) .
        '.' .
        $this-&gt;normalizeForKey($event) .
        '.' .
        $this-&gt;normalizeForKey($date);
}

/**
 * Normalize string for key format
 *
 * @param string $string String
 *
 * @return string String normalized
 */
public function normalizeForKey($string)
{
    return str_replace('.', '_', $string);
}
</code></pre>

<h3 id="used-adapter">Used Adapter<a class="headerlink" href="#used-adapter" title="Permanent link"> #</a></h3>
<p>The adapter used by the Dependency Injection is the one aliased with the name
<code>elcodi.metrics_bucket</code>.</p>
<p>If you want to change the adapter, the only thing you must do is overwrite the
Metric Bundle configuration in your project, by adding this in your
<code>/app/config/config_local.yml</code> file.</p>
<pre><code class="yaml">elcodi_metric:
    bucket:
        client: elcodi.redis_metrics_bucket
</code></pre>

<h3 id="adapters">Adapters<a class="headerlink" href="#adapters" title="Permanent link"> #</a></h3>
<p>These are our adapters included in the Core of the application. If you have
implemented another adapter and you think that can be interesting to share it,
then you can create a pull request with your work. We will appreciate it.</p>
<h4 id="redis-bucket-adapter">Redis Bucket Adapter<a class="headerlink" href="#redis-bucket-adapter" title="Permanent link"> #</a></h4>
<ul>
<li>Namespace - Elcodi\Component\Metric\Core\Bucket\RedisMetricsBucket</li>
<li>DI name - <code>elcodi.redis_metrics_bucket</code></li>
</ul>
<p>This extension doesn't need any extra installation. If redis-server is not
installed, then nothing happens. If it is, then will work properly.</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
                <p>Copyright © 2014/2015 <a href="http://www.elcodi.io">Elcodi</a>. All rights reserved.</p>
            
        </footer>

        <script src="../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../js/highlight.pack.js"></script>
        <script>var base_url = '../../..';</script>
        <script data-main="../../../mkdocs/js/search.js" src="../../../mkdocs/js/require.js"></script>
        <script src="../../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
